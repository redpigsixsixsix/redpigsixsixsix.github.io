---
title:  "什么是AMM自动做市商"
layout: post
---

# 什么是AMM

AMM的全称是Auto Market Maker，翻译成中文的名字叫做自动做市商。传统金融体系中的做市商，通常由交易所承担。交易所会同时进行双边报价交易，是以报价商为市场的价格维护人。  
报价商向市场同时报出买价和卖价，市场的买家和卖家根据报价与之成交，而买家和卖家之间不直接成交的交易组织模式。  

# DeFi当中的自动做市商体系

## 如何进行交易

在新型的DeFi(Decentralized Financial)体系当中，自动做市商并非由交易所运行，而是一个运行在公链上的合约。所有的交换报价全部由合约来完成。  
不论谁来问合约价格，它都能给出一个合理的报价。  

市场上最有名的自动做市商是Uniswap，它根据一个简单的定价算法，在两种资产之间随时提供报价。对 Uniswap 而言，它对这两种资产进行报价，其持有的每种资产的单位数相乘，总会等于一个常数。

这听上去有些拗口：如果 Uniswap 拥有一些 x 代币，拥有一些 y 代币，它给每一笔交易定价，所以，它拥有的 x 的最终数量，和拥有的 y 的最终数量，两者相乘会等于一个常数 k。这就形成了一个常数积的等式：`x * y = k`。

这种报价方式听起来可能有些奇怪，但是Uniswap自己就是这么做的。

假设我们在 Uniswap 的某个池里投入 50 个苹果 （a） 和 50 个香蕉 （b） ，任何人都可以用苹果换香蕉，或者用香蕉换苹果。假设一级市场中苹果与香蕉的汇率刚好是 1:1。因为该 Uniswap 资金池中分别有 50 个苹果和 50 个香蕉，因此，按上述常数积的等式规则，a * b = 2500 。对于任何交易，Uniswap 都需要保证，池中库存的苹果数和香蕉数相乘等于 2500。好了，假设一位客户进入我们的 Uniswap 池来买一个苹果。她应该支付多少个香蕉呢？如果她买走一个苹果，我们的池里就剩下 49 个苹果，而 49* b 依然需要等于 2500。这样香蕉的总数 b 就等于 51.02。由于之前池中有 50 个香蕉，因此我们还需要 1.02 个香蕉（在这个宇宙中我们允许碎片化香蕉的存在） ，因此，这位客户买一个苹果会得到的报价是：1.02 香蕉 / 苹果。请注意，这与两者之间 1:1 的原始价格很接近！因为这只是一笔小额交易，所以滑点较小。但如果订单很大呢？

如果她想买 10 个苹果， Uniswap 的报价会是 12.5 个香蕉，即这 10 个苹果每个的单价为 1.25 香蕉 / 苹果。如果她想要执行 25 个苹果这种大额交易，即要买库存苹果数量的一半，那么，单位价格会上涨到 2 香蕉 / 苹果！ （你能从直觉上明白这一点，因为池中的一种商品减半，另一种就得翻倍）重要的是需要明白，Uniswap 不能偏离这条定价曲线。如果某人要购买一些苹果，后来又有人要买一些香蕉， Uniswap 就会在这条价格曲线上来回移动，无论需求把它带向何方。

这里有个好玩的地方：如果苹果与香蕉之间的真实交易价格是 1:1，当第一位客户买走 10 个苹果后，我们 Uniswap 池就有会变成 40 个苹果和 62.5 个香蕉。如果有位套利者此时进入，她买走 12.5 个香蕉，让资金池恢复到最初状态，她只需付 10 个苹果，所以 Uniswap 对她的收费只有 0.8 苹果 / 香蕉。Uniswap 会低价甩卖香蕉！就好像我们的算法此时意识到香蕉过多，所以它低价抛售香蕉，以吸引苹果流入，从而实现库存的再平衡。只要稍微偏离真实的交易价格，就会在套利者的帮助下回复正常。

## 套利损失

Uniswap通过反函数的定价机制来报价，但是这种方法会产生一种套利损失的概念。

Uniswap 会对每笔交易收取少量费用 （目前为 0.3%） 。这是在名义价格之外的。因此，如果苹果和香蕉总是且永远以 1:1 价格进行交易，随着做市商在交易价格曲线上来回移动，这些费用将随时间累积。那么，与只持有 50 个苹果和 50 个香蕉的基线比较，Uniswap 池最终会积累更多的水果。

但是，如果苹果和香蕉之间的真实交易价格突然发生变化，会发生什么呢？假设某家香蕉农场遭遇了无人机攻击，出现大面积的香蕉短缺。香蕉现在像黄金一样贵。交易价格蹿升到 5 个苹果换 1 个香蕉。Uniswap 上会发生什么？套利者一秒都不会耽搁，立马杀入你的 Uniswap 池，抢购便宜的香蕉。他们调整交易规模，以便买走价格低于新汇率 5:1 的所有香蕉。这意味着他们需要移动价格曲线，直到满足以下等式：5x * x = 2500。

算一下这个数学题，你会得到如下结果：他们总共以 61.80 个苹果买到 27.64 个香蕉。平均交易价格为 2.2 个苹果：1 个香蕉，这远低于市场价，相当于得到 76.4 个免费苹果。他们的利润从何而来？当然这是以牺牲资金池为代价的！而且，如果数一下你会发现，与某个持有最初的 50 个苹果和 50 个香蕉的人相比，Uniswap 池现在恰好下降了 76.4 个苹果的价值。Uniswap 出售香蕉的价格太便宜，因为它不知道香蕉在现实世界中变得如此值钱。

这种现象称为「套利 损失」。每当交易价格发生变动，就会出现套利者窃取廉价资产，直到资金池的定价达到正确为止。 （这些损失是「暂时的」，因为如果后来真实交易价格恢复为 1：1，那么就好像你从未损失过这笔钱，和开始相比。）

资金池通过交易费赚钱，通过套利损失而亏钱。这都是需求和价格背离的一个函数——需求有利于资金池，而价格背离不利于资金池。

这就是 Uniswap 的简单概括。

## CFMM

类似的用常数函数作为定价方式的自动做市商被叫做CFMM(constant function market makers)。

一般而言，CFMM 中包括三类参与方，如下表所示。在这三类参与方中，最重要的角色是流动性提供者（LP），负责向 Uniswap 的智能合约中注入自己的资产，作为资产储备池，为交易提供流动性，并以此获取交易费用收益。其次是套利者，他们负责修正交易价格，保证交易价格与市场价格一致，但也会产生无常损失（Impermanent Loss），给流动性提供者带来亏损的风险。

![image.png](https://i.loli.net/2021/10/26/846MkayFTGptDqV.png)

## 存在的问题
### 独立定价问题
虽然有着如此简介精妙的设计，但是这种设计也造就了它的不足。在与传统交易制度竞争时，AMM 主要面临无法独立定价、无常损失和交易深度不足等问题，使得它很难取代传统的交易制度。

首先是资产交易的独立定价问题。在竞价制度中，价格优先原则是竞价市场上普遍采用的撮合原则，而且被作为首要的优先原则，即第一优先原则。它要求经纪商在接受委托进行交易时 , 必须按照最有利于委托人的利益买进或卖出资产 , 即买进资产时，较高的买进价格订单优先满足于较低的买进价格订单；卖出资产时，较低的卖出价格订单优先满足于较高的卖出价格订单。除价格优先原则外，还有时间优先，数量优先，按比例分配等原则，但在世界各大金融市场上，尽管第二乃至第三、第四等撮合原则上差别很大，但第一原则一定是价格优先原则，以此保证交易制度的价格发现功能。

做市商制度同样具有价格发现的功能。做市商的收益主要来源于买卖差价，在对市场进行做市时，以收益最大化为目标。这要求做市商必须充分利用市场信息，提出报价，与此同时，投资者根据做市商的报价做出投资决策，并将自己的交易信息及时反馈给做市商，随后做市商再根据手上的资产头寸和价格差异调整报价。因此，在做市商与投资者的共同推动下，市场可以发现真实的交易价格。

然而，自动化做市商制度却没有价格发现的功能。比如在某一资产的交易上，用户 A （做市商 A）挂出的是 5 美元 / 手的买单，用户 B （做市商 B）挂出的是 10 美元 / 手的买单，在竞价制度或做市商制度下，用户 B （做市商 B）先实现交易，但在 Uniswap 平台上却无法保证用户 B 先成交。因为我们前面提到，AMM 的价格是靠流动性驱动的，交易价格由储备池的资产情况决定，而非订单价格决定，即 AMM 只能产生交易价格，却不能发现市场价格。为此，AMM 不得不引入套利者这一重要角色：一旦 AMM 平台上的价格与市场公允价格不同，就会出现套利空间，并将价格拉回正轨。

金融市场交易制度的核心是发现价格功能，无法发现价格的交易制度注定无法成为主流。因此，从未来发展看，自动做市商制度很难取代现有的竞价制度和做市商制度，但可以凭借其简洁灵活的交易特征，成为金融市场交易的补充。

### 无偿损失问题
另外一个问题是无偿损失。  

在上文中我们提到，由于模型设计上的缺陷，AMM 不得不引入套利机制以完善其价格机制。然而，这也带来了另一个严重后果---无常损失（Impermanent Loss）。无常损失实际上来源于套利行为。我们前面提前，AMM 的交易价格与市场公允价格是脱轨的，为此需要套利者进来购买被低估的资产或卖出高估的资产，直到 AMM 提供的价格跟外部市场匹配。因此，套利者的利润实际上来自于流动性提供者，由于套利给流动性提供者带来损失的这一部分就被称为无常损失。

我们以如下表格说明，在 Uniswap 的一个智能合约内有资产 A 1000 份，资产 B 10 份。

1. 初始时刻，资产 A 的价格为 1 美元，资产 B 的价格为 100 美元，此时资产池总价值为 1*1000+10*100=2000 美元；
2. T2 时刻，资产 B 的价格上升为 110 美元，此时资产池总价值变为 11000+10110=2100 美元。注意到 Uniswap 此时的兑换价格为资产 A 数量与资产 B 数量的比值，即 P = 1000/10 = 100，而在市场公允价格下，兑换价格为 110 美元 /1 美元 = 110，由此出现套利空间。
3. T3 时刻，套利者向该智能合约注入 48.81 份资产 A，换取 0.47 份资产 B。套利结束后，资产 A 有 1048.81 份，资产 B 剩余 9.53 份，此时储备池内资产总价值为 1048.811+9.53110=2097.62 美元，相较于套利前少了 2.38 美元，这部分损失即无常损失。

![image.png](https://i.loli.net/2021/10/26/dskI4OuxNtYbREA.png)

流动性提供者（LP）之所以为 AMM 提供流动性，是因为可以获取交易费用，然而无常损失的存在，提高了流动性提供者的风险。如果无常损失超过了流动性收益，那么 LP 将不再提供流动性。因此无常损失的大小是决定 AMM 类 DEX 能否正常运营的关键。

### 知情订单流问题

说白了，造成无偿损失的原因是因为市场上存在两种订单流，一种是知情订单流，一种是不知情订单流。    
做市商主要通过三种方式赚钱：指定做市安排（传统上由资产发行商支付费用） 、交易费回扣 （传统上由交易所支付） 以及从做市中赚价差（Uniswap 正是这种方式） 。  
你可以看到，所有的做市都是与两种订单流进行一场战斗：知情订单流和不知情订单流。假设你为 BTC/USD 市场报价，有一笔大额 BTC 卖单到了。你得问问自己：这是有人在换取流动性，还是这人知道一些我不清楚的消息？ 

如果这名交易对手知道庞氏骗局（PlusToken） 的缓存池发生了变动，卖压正在来袭，那么，你就只能用一些完美无缺的 USD 换一些前景不太妙的 BTC。另一方面，如果这只是某些无名人士在卖币，因为他们需要支付房租，那么，这就没什么特别的意义，你从他们身上赚价差就好了。作为一名做市商，你从不知情交易流中赚钱。不知情交易流是随机的——每天有人卖有人买，最终会相互抵消。如果对每笔交易赚价差，长期来说你会赚钱。 （这解释了为什么做市商们会花钱获得来自 Robinhood 交易所的订单流，因为后者多数是不知情的散户订单） 。

所以，一名做市商的首要任务是区分知情和不知情订单流。某个流是不知情的流的可能性越大，你收取的价差就该越高。如果这个订单流绝对是知情的，那你就应该完全撤回报价单，因为若是知情的交易方愿意与你交易，你绝对是要亏钱的。（考虑这一问题还有一种思路：不知情的订单流愿意为一种资产支付高于市价的价格， 这就是你赚的价差。而知情订单流只愿意以低于市价获取某种资产，所以，每当你与他们交易，你实际是在价格上吃亏的一方。这些订单知道你不知道的一些信息。）

同样的原则也适用于 Uniswap。有些人在 Uniswap 交易，因为他们完全是随机的想用 ETH 换 DAI 。对做市商而言，这是不知情的散户流，随机漫步的交易活动会带来费用收入。这很爽。你面对的还有套利者：他们是知情订单流。他们在选择价格错误的资金池。某种程度上说，他们其实是在帮助 Uniswap 将交易价格拉回正轨。但另一方面，他们是把 LP 的钱转移到他们自己的兜里。

做市商若要想赚钱，他们需要让不知情散户流与套利流之比做到最大。但 Uniswap 无法区分这两种流！

# 一些思考

可以预见，未来一定是DeFi的时代，去中心化的金融体系是全球化进程中重要的一环。  
随着进程的发展，AMM会吸引严肃的传统做市商，并且随着时间的推移，AMM的机制也会更加的完善，给用户带来更加简单高效的体验。  

